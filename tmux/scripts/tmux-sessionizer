#!/usr/bin/env bash

# Tmux sessionizer - fuzzy find directories and create/switch to sessions
# Searches common project directories and shows existing sessions

# Directories to search (add/remove as needed)
SEARCH_DIRS=(
    ~/Documents
    ~/Projects
    ~/Code
    ~/dev
    ~/work
    ~
)

# Build find command for existing directories only
find_dirs() {
    for dir in "${SEARCH_DIRS[@]}"; do
        dir="${dir/#\~/$HOME}"
        [[ -d "$dir" ]] && find "$dir" -mindepth 1 -maxdepth 1 -type d 2>/dev/null
    done | sort -u
}

# Get existing tmux sessions
get_sessions() {
    tmux ls -F "#{session_name}|#{session_path}" 2>/dev/null | while read -r line; do
        name="${line%%|*}"
        path="${line#*|}"
        echo "[session] $name ($path)"
    done
}

if [[ $# -eq 1 ]]; then
    selected="$1"
else
    # Combine directories and existing sessions
    selected=$( (get_sessions; find_dirs) | fzf \
        --height 80% \
        --reverse \
        --header "Select directory or session (Tab to see more)" \
        --preview '
            item={}
            if [[ "$item" == "[session]"* ]]; then
                # Extract session name
                session=$(echo "$item" | sed "s/\[session\] \([^ ]*\).*/\1/")

                attached=$(tmux display-message -t "$session" -p "#{?session_attached,attached,detached}" 2>/dev/null)
                printf "\033[1;32mSession: %s\033[0m  (%s)\n" "$session" "$attached"
                echo "─────────────────────────────────────"

                tmux list-windows -t "$session" -F "#{window_index}:#{window_name}" 2>/dev/null | while read -r win; do
                    win_idx=$(echo "$win" | cut -d: -f1)
                    win_name=$(echo "$win" | cut -d: -f2-)
                    is_active=$(tmux display-message -t "$session:$win_idx" -p "#{?window_active,*, }" 2>/dev/null)
                    printf "\n\033[1;33m%s %s:%s\033[0m\n" "$is_active" "$win_idx" "$win_name"

                    tmux list-panes -t "$session:$win_idx" -F "#{pane_index}|#{pane_current_command}|#{pane_current_path}" 2>/dev/null | while read -r pane; do
                        pane_idx=$(echo "$pane" | cut -d"|" -f1)
                        pane_cmd=$(echo "$pane" | cut -d"|" -f2)
                        pane_path=$(echo "$pane" | cut -d"|" -f3 | sed "s|$HOME|~|")
                        printf "    \033[0;36m[%s]\033[0m %s \033[0;90m%s\033[0m\n" "$pane_idx" "$pane_cmd" "$pane_path"
                    done
                done
            else
                # Directory preview
                dir="$item"
                printf "\033[1;34mDirectory: %s\033[0m\n" "$(echo "$dir" | sed "s|$HOME|~|")"
                echo "─────────────────────────────────────"

                # Check if git repo
                if [[ -d "$dir/.git" ]]; then
                    branch=$(git -C "$dir" branch --show-current 2>/dev/null)
                    printf "\033[0;32mGit repo\033[0m (branch: %s)\n\n" "$branch"
                fi

                # Show directory contents
                CLICOLOR_FORCE=1 ls -laG "$dir" 2>/dev/null | head -20
            fi
        ' \
        --preview-window "right:50%:wrap" \
    )
fi

[[ -z "$selected" ]] && exit 0

# Handle existing session selection
if [[ "$selected" == "[session]"* ]]; then
    selected_name=$(echo "$selected" | sed 's/\[session\] \([^ ]*\).*/\1/')
else
    selected_name=$(basename "$selected" | tr '.& ' '_')
fi

tmux_running=$(pgrep tmux)

# Not in tmux and tmux not running - create new session
if [[ -z "$TMUX" ]] && [[ -z "$tmux_running" ]]; then
    if [[ "$selected" == "[session]"* ]]; then
        tmux attach -t "$selected_name"
    else
        tmux new-session -s "$selected_name" -c "$selected"
    fi
    exit 0
fi

# Create session if it doesn't exist (only for directories)
if [[ "$selected" != "[session]"* ]] && ! tmux has-session -t="$selected_name" 2>/dev/null; then
    tmux new-session -ds "$selected_name" -c "$selected"
fi

# Attach or switch
if [[ -z "$TMUX" ]]; then
    tmux attach -t "$selected_name"
else
    tmux switch-client -t "$selected_name"
fi
